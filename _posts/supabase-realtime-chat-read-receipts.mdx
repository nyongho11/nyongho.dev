---
title: Supabaseì˜ ì‹¤ì‹œê°„ ì±„íŒ…ì—ì„œ ì½ìŒ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ê³¼ì •
description: ë©”ë§ëë˜ ì±„íŒ… ì•±ì— ì½ìŒ ê¸°ëŠ¥ í•œ ìŠ¤í‘¼ì„ ì²¨ê°€í•œ ê³¼ì •ì„ ë‹¤ë£¹ë‹ˆë‹¤.
date: "2024-08-12T16:14:00.322Z"
---

ì´ë²ˆ ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì˜ ëª©í‘œ ì¤‘ í•˜ë‚˜ì˜€ë˜ 1:1 ì‹¤ì‹œê°„ ì±„íŒ… ê¸°ëŠ¥ì„ Supabaseë¥¼ í†µí•´ ê°œë°œí–ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ê¸°ë³¸ì ì¸ ì±„íŒ… ê¸°ëŠ¥ì„ ë§Œë“¤ê³  ë‚˜ë‹ˆ ë­”ê°€ 2% ë¶€ì¡±í•œ ëŠë‚Œì´ ë“¤ë”ë¼ê³ ìš”. ğŸ¤” ë­ê°€ ë¹ ì¡Œì„ê¹Œ ê³ ë¯¼í•˜ë‹¤ê°€, ì¹œêµ¬ì—ê²Œ ë³´ë‚¸ ì¸ìŠ¤íƒ€ê·¸ë¨ DMì„ ë³´ê³  ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.

![ì¸ìŠ¤íƒ€ê·¸ë¨ DM](/assets/blog/supabase-realtime-chat-read-receipts/image-1.jpeg)

**ê·¸ë˜ ì´ê±°ë‹¤**

ë³´í†µ ì±„íŒ… ì•±ë“¤ì€ ìƒëŒ€ë°©ì´ ë‚´ ë©”ì‹œì§€ë¥¼ ì½ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì§€ì›í•˜ê¸°ì— ì´ê²ƒê¹Œì§€ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ ì¡ì•˜ìŠµë‹ˆë‹¤.

### DB í•„ë“œ ì¶”ê°€

ë¨¼ì € ê¸°ì¡´ì˜ ë©”ì„¸ì§€ ëª¨ë¸ì— ê° ë©”ì‹œì§€ì˜ ì½ìŒ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚¼ `isRead`í•„ë“œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

```java
model Message {
  id          Int       @id @default(autoincrement())
  payload     String
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])
  chatRoom    ChatRoom  @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  chatRoomId  String
  userId      Int
  // isRead í•„ë“œ ì¶”ê°€
  isRead      Boolean   @default(false)
}
```

### ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬ í•˜ëŠ” ì„œë²„ í•¨ìˆ˜ ìƒì„±

ì´ë¡œì¨ ê° ë©”ì‹œì§€ëŠ” ëª¨ë‘ `isRead`ìƒíƒœë¥¼ ê°€ì§€ê²Œ ëìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì½ìŒ ì²˜ë¦¬ë¥¼ í•˜ë ¤ë©´, ìƒëŒ€ë°©ì´ ë³´ë‚¸ ëª¨ë“  ë©”ì„¸ì§€ë¥¼ ì½ìŒ ì²˜ë¦¬ í•´ì•¼í–ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ í•´ë‹¹ ì±„íŒ…ë°©ì—ì„œ ìƒëŒ€ë°©ì˜ ë©”ì‹œì§€ ì¤‘ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì½ìŒ ì²˜ë¦¬í•˜ëŠ” ì„œë²„ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì¤¬ìŠµë‹ˆë‹¤.

```typescript
export async function markMessagesAsRead(chatRoomId: string) {
  const session = await getSession();

  await db.message.updateMany({
    where: {
      chatRoomId,
      isRead: false,
      userId: {
        not: session.id,
      },
    },
    data: {
      isRead: true,
    },
  });

  revalidatePath("/chats");
}
```

ê·¸ ë‹¤ìŒ `useEffect`ë¥¼ ì‚¬ìš©í•´ ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë  ë•Œ Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•˜ê³ , íŠ¹ì • ì±„íŒ…ë°©(`chatRoomId`)ì„ êµ¬ë…í•˜ë„ë¡ ì„¤ì •í–ˆì–´ìš”. `broadcast` ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•´ì„œ, ë©”ì‹œì§€ê°€ ìˆ˜ì‹ ë  ë•Œë§ˆë‹¤ `setMessages`ë¥¼ í†µí•´ ë©”ì‹œì§€ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë•ë¶„ì— ìœ ì €ê°€ ìƒˆë¡œê³ ì¹¨ì„ í•˜ì§€ ì•Šì•„ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
useEffect(() => {
  const client = createClient(String(SUPABASE_URL), String(SUPABASE_KEY));

  channel.current = client.channel(`chatRoom-${chatRoomId}`);

  channel.current
    .on("broadcast", { event: "message" }, (payload) => {
      setMessages((prevMsgs) => [...prevMsgs, payload.payload]);
    })
    .subscribe();

  return () => {
    channel.current?.unsubscribe();
  };
}, [chatRoomId]);
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œ ë³´ë‚´ëŠ” `newMessage` ê°ì²´ì— `isRead` ê°’ì„ ì¶”ê°€í•´ì„œ ê¸°ë³¸ê°’ì„ `false`ë¡œ ì„¤ì •í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

```typescript
const onSubmit = async (event: React.FormEvent) => {
  event.preventDefault();

  const newMessage = {
    id: Date.now(),
    payload: inputMessage,
    created_at: new Date(),
    userId,
    user: {
      username,
      avatar,
    },
    // isReadê°€ falseì¸ ì±„ë¡œ ì „ì†¡
    isRead: false,
  };

  setMessages((prevMsgs) => [...prevMsgs, newMessage]);

  channel.current?.send({
    type: "broadcast",
    event: "message",
    payload: newMessage,
  });

  await saveMessage(inputMessage, chatRoomId, false);
  setInputMessage("");
};
```

ì—¬ê¸°ê¹Œì§€ êµ¬í˜„ì„ í•˜ê³  ë‚œ ë’¤ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì´ ê³¼ì •ì—ì„œ ë­”ê°€ ì–´ìƒ‰í•œ ì ì„ ë°œê²¬í–ˆì–´ìš”. ğŸ¤¨

ë¬¸ì œëŠ” ìœ„ í•¨ìˆ˜ì—ì„œ `isRead` ìƒíƒœê°€ í•­ìƒ `false`ë¡œ ì €ì¥ëœë‹¤ëŠ” ì ì´ì—ˆì–´ìš”. ì´ ë•Œë¬¸ì— ë‹¤ìŒì˜ ìƒí™©ì—ì„œëŠ” ì œì•½ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

- ìœ ì € Aì™€ Bê°€ ë™ì‹œì— ì±„íŒ…ë°©ì— ì ‘ì†í•´ ìˆì„ ë•Œ, ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ë”ë¼ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ `ì½ìŒ` ìƒíƒœë¥¼ ë°˜ì˜í•  ìˆ˜ ì—†ì—ˆì–´ìš”.
- ìœ ì € Aê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í›„, ìœ ì € Bê°€ ì±„íŒ…ë°©ì— ë°”ë¡œ ì ‘ì†í–ˆì„ ë•Œë„ ìœ ì € AëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ `ì½ìŒ` ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ì—ˆì–´ìš”.
- ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìœ ì € AëŠ” ì±„íŒ…ë°©ì„ ë‚˜ê°”ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì™€ì•¼í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ìˆì—ˆì–´ìš”.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë³´ì™„ëœ íë¦„ì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.

- **ë‹¨ë… ì…ì¥í•œ ìƒíƒœ**:
  - ìœ ì €ê°€ ì±„íŒ…ë°©ì— ì…ì¥í•˜ë©´ ìƒëŒ€ë°©ì´ ë³´ë‚¸ ëª¨ë“  ë©”ì‹œì§€ë¥¼ `ì½ìŒ` ì²˜ë¦¬.
  - ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ë•ŒëŠ” `ì½ì§€ ì•ŠìŒ` ìƒíƒœë¡œ ì „ì†¡.

* **í•¨ê»˜ ì…ì¥í•œ ìƒíƒœ**:
  - ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ `ì½ìŒ` ìƒíƒœë¡œ ë³´ë‚´ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ `ì½ìŒ` ì²˜ë¦¬.
  - ì¤‘ê°„ì— ìœ ì €ê°€ ì ‘ì†í•˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ `ì½ìŒ` ì²˜ë¦¬.

ê·¸ë¦¬ê³  ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Supabase ê³µì‹ë¬¸ì„œë¥¼ ì½ë˜ ì¤‘ **Presence**ë¼ëŠ” ë©”ì†Œë“œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

### [Presence](https://supabase.com/docs/guides/realtime/presence?queryGroups=language&language=js)

> You can use the Supabase client libraries to track Presence state between users.

ì‹¤ì‹œê°„ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ `ì½ìŒ` ì²˜ë¦¬ë¥¼ í•˜ê¸° ìœ„í•´ì„œëŠ” ìœ ì €ì˜ ì±„íŒ…ë°© ì ‘ì† ì—¬ë¶€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  í•„ìš”ê°€ ìˆì—ˆê³ , ì´ ë©”ì†Œë“œëŠ” ê·¸ ëª©ì ì— ë”± ë§ëŠ” ê¸°ëŠ¥ì´ì—ˆìŠµë‹ˆë‹¤.

ì´ì œ ì´ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•´ êµ¬í˜„ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.

1. **ì±„ë„ ìƒì„± ë° Presence ì„¤ì •**
   ë¨¼ì €, ì±„ë„ì„ ìƒì„±í•˜ê³  íŠ¹ì • ì‚¬ìš©ìì˜ ì‹¤ì‹œê°„ ìƒíƒœë¥¼ Presence ê¸°ëŠ¥ì„ í†µí•´ ì¶”ì í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ key ê°’ì€ ê³ ìœ í•´ì•¼ í•©ë‹ˆë‹¤.

```typescript
import { createClient } from "@supabase/supabase-js";

const client = createClient(String(SUPABASE_URL), String(SUPABASE_KEY));
channel.current = client.channel(`chatRoom-${chatRoomId}`, {
  config: {
    presence: {
      key: String(userId),
    },
  },
});
```

2. **Presence ì´ë²¤íŠ¸ ì²˜ë¦¬**  
   Presence ë©”ì„œë“œëŠ” ìœ ì €ê°€ ì±„ë„ì— ì°¸ì—¬(`join`)í•˜ê±°ë‚˜ í‡´ì¥(`leave`)í•˜ê±°ë‚˜ ìƒíƒœë¥¼ ë³€ê²½í•  ë•Œ íŠ¸ë¦¬ê±°ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì €ëŠ” `sync` ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•´ì„œ ìœ ì €ì˜ ìƒíƒœê°€ ë³€ê²½ë˜ë©´ ì•Œë¦¼ì„ ë°›ë„ë¡ í–ˆì–´ìš”. ê·¸ë¦¬ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ `ì½ìŒ` ì²˜ë¦¬ë¥¼ ìœ„í•´, í˜„ì¬ ì ‘ì†í•œ ìœ ì € ìˆ˜ê°€ 2ëª… ì´ìƒì¼ ê²½ìš°, ë©”ì‹œì§€ë¥¼ `ì½ìŒ` ì²˜ë¦¬í•˜ëŠ” ì„œë²„ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë„ë¡ í–ˆê³ , `onlineUsers`ì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ë©´ì„œ ë¦¬ë Œë”ë§ì´ ìœ ë„ë˜ì–´, ìœ ì €ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ `ì½ìŒ` ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

```typescript
channel.current
  .on("broadcast", { event: "message" }, (payload) => {
    setMessages((prevMsgs) => [...prevMsgs, payload.payload]);
  })
  .on("presence", { event: "sync" }, () => {
    const newState = channel.current!.presenceState();
    const onlineUsers = Object.keys(newState).length;

    if (onlineUsers > 1) {
      markMessagesAsRead(chatRoomId);
    }

    setOnlineUsers(onlineUsers);
  })
  .subscribe();
```

3. ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í–ˆë‹¤ë©´ í•´ë‹¹ ì±„ë„ì„ êµ¬ë…í•˜ê³  ìˆëŠ” ëª¨ë“  ìœ ì €ì—ê²Œ ìƒíƒœë¥¼ ì „ì†¡í•´ì•¼ í•˜ëŠ”ë°ìš”. ì´ë¥¼ ìœ„í•´ `track()` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
const userStatus = {
  online_at: new Date().toISOString(),
  userId,
};
channel.current.track(userStatus);
```

ì´ë ‡ê²Œ í•˜ë©´ ë™ì¼í•œ ì±„íŒ…ë°©ì„ êµ¬ë…í•˜ëŠ” ë‹¤ë¥¸ ìœ ì €ì˜ ìƒíƒœ (ì—¬ê¸°ì„œëŠ” `userStatus`)ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ëª¨ë“  ìœ ì €ëŠ” ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ë°›ìœ¼ë©´ ìë™ìœ¼ë¡œ ìì‹ ì˜ `sync`ì™€ `join` ì´ë²¤íŠ¸ê°€ íŠ¸ë¦¬ê±°ë˜ê²Œ ë˜ì£ .

ì¦‰, ìœ ì €ì˜ ì ‘ì† ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ Supabaseê°€ ìë™ìœ¼ë¡œ í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ì˜ `sync`ì™€ `join` ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì‹¤í–‰í•´ì£¼ëŠ” ê²ë‹ˆë‹¤. ë•ë¶„ì—, í´ë¼ì´ì–¸íŠ¸ê°€ ìƒíƒœë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë™ê¸°í™”í•˜ê±°ë‚˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì§ì ‘ íŠ¸ë¦¬ê±°í•  í•„ìš”ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤.

### ìµœì¢… ì½”ë“œ

ì´ë ‡ê²Œ ì™„ì„± ëœ ìµœì¢…ì ì¸ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```typescript
useEffect(() => {
  // í´ë¼ì´ì–¸íŠ¸ ìƒì„± ë° ì„¤ì •
  const client = createClient(String(SUPABASE_URL), String(SUPABASE_KEY));
  channel.current = client.channel(`chatRoom-${chatRoomId}`, {
    config: {
      presence: {
        key: String(userId),
      },
    },
  });

  channel.current
    // ë©”ì‹œì§€ ì´ë²¤íŠ¸ êµ¬ë…
    .on("broadcast", { event: "message" }, (payload) => {
      // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
      setMessages((prevMsgs) => [...prevMsgs, payload.payload]);
    })
    // ì ‘ì† ì´ë²¤íŠ¸ êµ¬ë…
    .on("presence", { event: "sync" }, () => {
      const newState = channel.current!.presenceState();
      const onlineUsers = Object.keys(newState).length;
      // ì ‘ì†ìê°€ 2ëª…ì´ ë˜ë©´ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
      if (onlineUsers > 1) {
        markMessagesAsRead(chatRoomId);
      }
      // ì ‘ì†ì ìˆ˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì½ìŒ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜)
      setOnlineUsers(onlineUsers);
    })
    .subscribe();

  // ìœ ì € ì ‘ì† ì •ë³´ ì¶”ì 
  channel.current.track({
    online_at: new Date().toISOString(),
    userId,
  });

  return () => {
    channel.current?.unsubscribe();
  };
}, [chatRoomId, userId]);
```

```typescript
const onSubmit = async (event: React.FormEvent) => {
  event.preventDefault();

  // í˜„ì¬ ì±„íŒ…ë°©ì— ë‘ ëª… ì´ìƒì˜ ì‚¬ìš©ìê°€ ìˆì„ ê²½ìš° ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
  const isRead = onlineUsers > 1;

  const newMessage = {
    id: Date.now(),
    payload: inputMessage,
    created_at: new Date(),
    userId,
    user: {
      username,
      avatar,
    },
    isRead,
  };

  // ë©”ì‹œì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
  setMessages((prevMsgs) => [...prevMsgs, newMessage]);

  // ì±„ë„ì— ë©”ì‹œì§€ ì´ë²¤íŠ¸ ì „ì†¡
  channel.current?.send({
    type: "broadcast",
    event: "message",
    payload: newMessage,
  });

  // DBì— ë©”ì‹œì§€ ì €ì¥
  await saveMessage(inputMessage, chatRoomId, isRead);

  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
  setInputMessage("");
};
```

### ìµœì¢… ê²°ê³¼

ê·¸ë¦¬ê³  ì™„ì„±ëœ ìµœì¢… ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![ìµœì¢… ê²°ê³¼](/assets/blog/supabase-realtime-chat-read-receipts/image-2.gif)
